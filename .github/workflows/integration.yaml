name: Integration Tests

on:
  workflow_run:
    workflows: ['API Generation']
    types:
      - completed

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4

      - name: Download backend API
        uses: actions/download-artifact@v4
        with:
          name: backend-api
          path: ./backend/api

      - name: Download frontend API
        uses: actions/download-artifact@v4
        with:
          name: frontend-api
          path: ./frontend/src/api

      - name: Set up Docker
        run: |
          sudo systemctl start docker
          docker --version

      - name: Debug user info
        run: |
          echo "User: $(id -u)"
          echo "Group: $(id -g)"
          echo "Users in group 121: $(getent group 121 || echo 'Group 121 not found')"
          echo "All groups: $(id)"

      - name: Set up user info
        run: |
          echo "CURRENT_UID=$(id -u)" >> $GITHUB_ENV
          echo "CURRENT_GID=$(id -g)" >> $GITHUB_ENV
          echo "User: $(id -u), Group: $(id -g)"

      - name: Run integration tests
        run: |
          go test ./integration_tests/... -v
        env:
          DOCKER_HOST: unix:///var/run/docker.sock

      - name: Cleanup
        if: always()
        run: docker system prune -f
