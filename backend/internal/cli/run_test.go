package cli

import (
	"errors"
	"os"
	"path/filepath"
	"strings"
	"testing"
	"time"

	"omar-kada/autonas/internal/storage"
	"omar-kada/autonas/testutil"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/mock"
)

type Mocker struct {
	mock.Mock
}

func (m *Mocker) Exec(cmd string, cmdArgs ...string) error {
	args := m.Called(cmd, cmdArgs)
	return args.Error(0)
}

func initMemoryStorage(_ RunParams) (storage.Storage, error) {
	return testutil.NewMemoryStorage(), nil
}

func initConfigRepo(t *testing.T) string {
	remoteRepoPath := testutil.SetupRemoteRepo(t)
	homepageComposeFile, err := os.ReadFile("test_data/homepage/compose.yaml")
	assert.NoError(t, err, "error while reading homepage compose file")
	homepageEnvFile, err := os.ReadFile("test_data/homepage/env")
	assert.NoError(t, err, "error while reading homepage env file")
	testutil.AddCommitToRepo(t, remoteRepoPath, "services/homepage/compose.yaml", homepageComposeFile)
	testutil.AddCommitToRepo(t, remoteRepoPath, "services/homepage/.env", homepageEnvFile)
	if err != nil {
		t.Fatal(err)
	}
	return remoteRepoPath
}

func TestRunCommand_CmdParams(t *testing.T) {
	baseDir := t.TempDir()
	mocker := &Mocker{}
	cmd := NewRunCommand(mocker, initMemoryStorage)

	servicesDir := filepath.Join(baseDir, "services")
	dataDir := filepath.Join(baseDir, "data")
	workingDir := filepath.Join(baseDir, "work")
	configFile := filepath.Join(workingDir, "config.yaml")
	os.MkdirAll(servicesDir, 0o750)
	os.MkdirAll(dataDir, 0o750)
	os.MkdirAll(workingDir, 0o750)

	mocker.On(
		"Exec", "docker",
		[]string{"compose", "--project-directory", filepath.Join(servicesDir, "homepage"), "up", "-d"},
	).Return(nil)

	remoteRepoPath := initConfigRepo(t)

	err := os.WriteFile(configFile,
		[]byte(strings.Join([]string{
			"settings:",
			"  repo: \"" + remoteRepoPath + "\"",
			"  cron : 1",
			"environment:",
			"  SERVICES_PATH: " + servicesDir,
			"  DATA_PATH: " + dataDir,
			"services:",
			"  homepage:",
			"    port : 12345",
		}, "\n")), 0o750)
	assert.NoError(t, err, "error while creating config file")

	t.Setenv("AUTONAS_CONFIG_FILE", "")
	t.Setenv("AUTONAS_WORKING_DIR", "")

	go func() {
		cmd.SetArgs([]string{
			"-f", configFile,
			"-d", workingDir,
			"-s", servicesDir,
			"-w", "true",
			"-p", "5008",
		})
		cmd.Execute()
	}()

	targetFile := filepath.Join(servicesDir, "homepage", ".env")

	ok := testutil.WaitForFile(targetFile, 10*time.Second)
	assert.True(t, ok, "homepage files should be created")
}

func TestRunCommand_EnvParams(t *testing.T) {
	baseDir := t.TempDir()
	mocker := &Mocker{}
	cmd := NewRunCommand(mocker, initMemoryStorage)

	servicesDir := filepath.Join(baseDir, "services")
	dataDir := filepath.Join(baseDir, "data")
	workingDir := filepath.Join(baseDir, "work")
	configFile := filepath.Join(workingDir, "config.yaml")
	os.MkdirAll(servicesDir, 0o750)
	os.MkdirAll(dataDir, 0o750)
	os.MkdirAll(workingDir, 0o750)

	mocker.On(
		"Exec", "docker",
		[]string{"compose", "--project-directory", filepath.Join(servicesDir, "homepage"), "up", "-d"},
	).Return(nil)

	remoteRepoPath := initConfigRepo(t)

	err := os.WriteFile(configFile,
		[]byte(strings.Join([]string{
			"settings:",
			"  repo: \"" + remoteRepoPath + "\"",
			"  cron : 1",
			"environment:",
			"  SERVICES_PATH: " + servicesDir,
			"  DATA_PATH: " + dataDir,
			"services:",
			"  homepage:",
			"    port : 12345",
		}, "\n")), 0o750)
	assert.NoError(t, err, "error while creating config file")

	t.Setenv("AUTONAS_CONFIG_FILE", configFile)
	t.Setenv("AUTONAS_WORKING_DIR", workingDir)
	t.Setenv("AUTONAS_SERVICES_DIR", servicesDir)
	t.Setenv("AUTONAS_ADD_WRITE_PERM", "true")
	t.Setenv("AUTONAS_PORT", "5009")

	go func() {
		cmd.Execute()
	}()

	targetFile := filepath.Join(servicesDir, "homepage", ".env")

	ok := testutil.WaitForFile(targetFile, 10*time.Second)
	assert.True(t, ok, "homepage files should be created")

	// Assert file content
	want := []string{
		"# The next values are generated by AutoNAS :",
		"DATA_PATH=" + dataDir,
		"SERVICES_PATH=" + servicesDir,
		"PORT=12345",
	}

	content, err := os.ReadFile(targetFile)
	assert.NoError(t, err, "error reading target file")
	for _, val := range want {
		assert.Contains(t, string(content), val, "file should contain correct all env vars")
	}
}

func TestRunCommand_WithInvalidConfig(t *testing.T) {
	mocker := &Mocker{}
	cmd := NewRunCommand(mocker, func(_ RunParams) (storage.Storage, error) {
		return nil, errors.New("mock error")
	})

	// Create a channel to capture the command's exit status
	done := make(chan error, 1)

	go func() {
		err := cmd.Execute()
		done <- err
	}()

	select {

	case cmdErr := <-done:
		assert.ErrorContains(t, cmdErr, "mock error")
	case <-time.After(1 * time.Second):
		assert.Fail(t, "timeout while waiting for command error")
	}
}
